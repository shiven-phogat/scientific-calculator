---
# Playbook Name: Scientific Calculator Docker Deployment
# FIX: Renamed the internal variable to 'docker_image' to resolve the recursive templating error.
- hosts: local
  connection: local
  become: yes # Added 'become: yes' to ensure Docker commands can be executed
  gather_facts: false

  vars:
    # -----------------------------------------------------------------------------------
    # FIX: We changed 'image' to 'docker_image' here. 
    # This variable is now set to the value of the 'image' variable passed via 
    # the command line (-e image=...) OR defaults to the hardcoded value if 'image' 
    # is not provided.
    # -----------------------------------------------------------------------------------
    docker_image: "{{ image | default('swenforgets/scientific-calculator:latest') }}"
    container_name: "scientific_calculator"
    host_port: 5000
    container_port: 5000

  tasks:
    - name: Ensure Python dependencies for Docker are installed system-wide
      # This task uses 'become: yes' (inherited from the play) to install dependencies 
      # globally, solving the 'No module named requests' error.
      ansible.builtin.pip:
        name:
          - docker
          - requests
        state: present

    - name: Pull image from Docker Hub
      tags: pull_image
      community.docker.docker_image:
        # Use the fixed internal variable name 'docker_image'
        name: "{{ docker_image }}"
        source: pull
        state: present

    - name: Run calculator container (expose port {{ host_port }})
      tags: run_container
      community.docker.docker_container:
        name: "{{ container_name }}"
        # Use the fixed internal variable name 'docker_image'
        image: "{{ docker_image }}"
        state: started
        restart_policy: unless-stopped
        published_ports:
          - "{{ host_port }}:{{ container_port }}"